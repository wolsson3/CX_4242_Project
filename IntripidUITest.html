<!DOCTYPE html>
<html>
    <head>
        <title>Intripid</title>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
      <style>

          body {
              padding: 0px 15px 15px 15px;
          }
          #mainContainer {
              width: 100%;
              height: 100%
              padding: 100px 100px 100px 100px;
              float: bottom;
          }
          #mainMap {

              height: 400px;
              width: 50%;
              float: left;
          }
          .container {
              height: 100%;
              width: 50%;
              float: right;
          }
          .container button {
              float: right;
              size: 50;
          }

          .destBox {
              width: 70%;
              float: right;
          }
          #carForm p {
              float: right;
          }
          .avgBox {
              float: right;
          }

      </style>
    </head>

    <body>
            <h1> Intripid </h1>
      <div id="mainContainer">
          <div id="mainMap"></div>
          <div class="container">
              <h3>Trip Details</h3><button id="rerouteBtn" onclick="route()">Calculate Route</button>
              <p>Give us some details below so we can help plan your next trip.</p>
              <div class="panel-group" id="accordion">
                  <div class="panel panel-default">
                      <div class="panel-heading">
                          <h5 class="panel-title">
                              <a data-toggle="collapse" data-parent="#accordion" href="#destinations">Destinations</a>
                          </h5>
                      </div>
                      <div id="destinations" class="panel-collapse collapse in">
                          <div class="panel-body">


                              <form id="destForm">
                                  <label>Starting Location:</label>
                                  <input type="text" class="destBox" name="startingLoc" id="from" value="jacksonville, FL"><br>
                                  <input type="checkbox" id="isRoundTrip">Is this a round trip?<br><br>
                                  <label>Desired Destinations:</label>
                                  <input type="text" class="destBox" name="desiredDests" id="desiredDests" value="miami, FL"><br><br>
                                  <label>Must Go Destinations:</label>
                                  <input type="text" class="destBox" name="mustGoDest">
                                  <label>Site Categories:</label>
                                  <input type="text" id="type" value="amusement_park, zoo, library, movie_theater, park, spa, gym, department_store, city_hall, church, night_club, museum, library" />
                              </form>


                          </div>
                      </div>
                  </div>
                  <div class="panel panel-default">
                      <div class="panel-heading">
                          <h5 class="panel-title">
                              <a data-toggle="collapse" data-parent="#accordion" href="#carDetails">Car Details</a>
                          </h5>
                      </div>
                      <div id="carDetails" class="panel-collapse collapse in">
                          <div class="panel-body">


                              <form id="carForm">
                                  <label>Year:</label><p><b>Or eneter your average MPG:</b></p>
                                  <input type="text" name="carYear"><br><br><input type="text" name="userAvgMpg" class="avgBox">
                                  <label>Make:</label>
                                  <input type="text" name="carMake"><br><br>
                                  <label>Model:</label>
                                  <input type="text" name="carModel">
                              </form>


                          </div>
                      </div>
                  </div>
                  <div class="panel panel-default">
                      <div class="panel-heading">
                          <h5 class="panel-title">
                              <a data-toggle="collapse" data-parent="#accordion" href="#tripDetails">Additional Trip Options</a>
                          </h5>
                      </div>
                      <div id="tripDetails" class="panel-collapse collapse in">
                          <div class="panel-body">


                              <form id="tripForm">
                                  <label>Maximum Trip Cost:</label>
                                  <input type="text" name="desiredMaxCost"><br><br>
                                  <label>Maximum Trip Distance:</label>
                                  <input type="text" name="maxDist"><br><br>
                                  <label>Maximum Trip Duration:</label>
                                  <input type="text" name="maxDuration"><br><br>
                                  <label>Distance Off Route for Stops:</label>
                                  <input type="text" id="distance" name="distance" value="8">
                              </form>


                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>


        </div>

        <!-- <script src="../CX_4242_Project/yelp-fusion/fusion/node/sample.js" type="text/javascript"></script> -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrCcldEQujP8HSzB7tN6UPtvls9CwC8ZU"></script>
        <script src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
        <script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/routeboxer/src/RouteBoxer.js" type="text/javascript"></script>
        <script type="text/javascript">

            var map = null;
            var directions = null;
            var routeBoxer = null;
            var distance = null; // km
            var service = null;
            var boxes = null;
            var infowindow = new google.maps.InfoWindow();
            var places = [];
            var dirresult = null;
            var markersArray = [];
            var boxesArray = null;



            function initialize() {
              // Default the map view to the continental U.S.
              var mapOptions = {
                center: new google.maps.LatLng(40, -80.5),
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoom: 8
              };

              map = new google.maps.Map(document.getElementById("mainMap"), mapOptions);
              service = new google.maps.places.PlacesService(map);

              routeBoxer = new RouteBoxer();

              directionService = new google.maps.DirectionsService();
              directionsRenderer = new google.maps.DirectionsRenderer({
                map: map
              });

            }


            function geocodeLatLong(geocoder, lat, lng) {
              var latlng = {lat: lat, lng: lng};
              geocoder.geocode({'location': latlng}, function(results, status) {
              if (status === 'OK') {
                if (results[0]) {
                  var address = results[0]['address_components'];
                  for (var i = 0; i < address.length; i++) {
                    if (address[i]['types'].length == 2 && address[i]['types'][0] == 'administrative_area_level_1'){
                      var state = address[i]['long_name'];
                      //console.log(state)
                    }
                  }
                  //console.log(results[0]['address_components'])
                  //return state

                  // map.setZoom(11);
                  // var marker = new google.maps.Marker({
                  //   position: latlng,
                  //   map: map
                  // });
                  // infowindow.setContent(results[0].formatted_address);
                  // infowindow.open(map, marker);
                } else {
                  window.alert('No results found');
                }
              } else if (status === 'OVER_QUERY_LIMIT') {
                setTimeout(function() {
                  return geocodeLatLong(geocoder, lat, lng);
                  }, 200);
              }
            });

            }


            function route() {
              // Clear any previous route boxes from the map
              clearOverlays();
              var geocoder = new google.maps.Geocoder;

              var start = document.getElementById("from").value;


              // Convert the distance to box around the route from miles to km
              distance = parseFloat(document.getElementById("distance").value) * 1.609344;
              var rawDests = document.getElementById('desiredDests').value;
              var destinations = rawDests.split(";");

              var formattedDests = [];
              for (var i =0; i < destinations.length; i++) {
                  formattedDests.push({
                      location: destinations[i],
                      stopover: true
                  });
                }

              var request = {
                origin: start,
                destination: start,
                waypoints: formattedDests,
                optimizeWaypoints: true,
                travelMode: google.maps.DirectionsTravelMode.DRIVING
              }

              // Make the directions request
              directionService.route(request, function(result, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                  directionsRenderer.setDirections(result);
                  dirresult = result;

                  // Box around the overview path of the first route
                  var path = result.routes[0].overview_path;
                  boxes = routeBoxer.box(path, distance);
                  var states = [];

                  for (var i = 0; i < boxes.length; i++) {
                    geocodeLatLong(geocoder, boxes[i].f.b, boxes[i].b.b);

                  }

                  drawBoxes();
                  findPlaces(0);

                } else {
                  alert("Directions query failed: " + status);
                }
              });
            }






            // Draw the array of boxes as polylines on the map
            function drawBoxes() {
              boxesArray = new Array(boxes.length);
              for (var i = 0; i < boxes.length; i++) {
                boxesArray[i] = new google.maps.Rectangle({
                  bounds: boxes[i],
                  fillOpacity: 0,
                  strokeOpacity: 1.0,
                  strokeColor: '#000000',
                  strokeWeight: 1,
                  map: map
                });
              }
            }


            function findPlaces(searchIndex) {
              var type = document.getElementById('type').value;
              var request = {
                bounds: boxes[searchIndex],
              };
              if (type.indexOf(',') > 0)
                  request.types = type.split(',');
                else
                  request.types = [type];

              service.radarSearch(request, function(results, status) {
                if (status == 'OK') {
                  for (var i = 0, result; result = results[i]; i++) {
                    service.getDetails(result, function(place, status) {
                      if (status == 'OK') {
                        if (place.photos && place.reviews && place.rating >= 3) {
                          var marker = createMarker(place);
                          places.push(place);
                        }
                      }
                    })
                  }}

                if (status != 'OVER_QUERY_LIMIT') {
                  searchIndex++;
                  if (searchIndex < boxes.length) {
                    //console.log('Searching boxes ' + searchIndex + "/" + boxes.length)
                    findPlaces(searchIndex);
                  } else {
                    recordPlaces();
                  }
                }

                else { // delay 1 second and try again
                  setTimeout("findPlaces(" + searchIndex + ")", 1000);
                }

              });
            }


            function clearOverlays() {
              // clear boxes
              if (boxesArray != null) {
                for (var i = 0; i < boxesArray.length; i++) {
                  boxesArray[i].setMap(null);
                }
              }
              boxesArray = null;

              // clear markers
              if (markersArray.length != 0) {
                for (var i = 0; i < markersArray.length; i++) {
                  markersArray[i].setMap(null);
                }
              }
              markersArray.length = 0;
              }






            function recordPlaces() {
              console.log("All Places:")
              console.log(places)
              //               var formattedDests = [];
              // for (var i =0; i < destinations.length; i++) {
              //     formattedDests.push({
              //         location: destinations[i],
              //         stopover: true
              //     });
              //   }

              categorieslist = [];
              totalgrade = 0;
              // iterate through each place
              for (var p = 0; p < places.length; p++) {
                // iterate through each type for this place
                for (var t = 0; t < places[p].types.length; t++) {
                    // assign the count to 1 if not already in the list, else increment by 1
                    typeof categorieslist[places[p].types[t]] === 'undefined' ? categorieslist[places[p].types[t]] = 1 : categorieslist[places[p].types[t]]++;
                 }
              }
              console.log("Count of Type Occurrances: *note that these overlap since sites have more than one type*")
              console.log(categorieslist)

              var top3places = [];
              for (var i = 0; i < places.length; i++) {
                var grade = places[i].rating / 5 * 70 + places[i].reviews.length / 5 * 0.15 + places[i].photos.length / 10 * 0.15;
                totalgrade += grade;
                if (top3places.length < 3) {
                  top3places.push(places[i]);

                } else {
                  for (var j = 0; j < top3places.length; j++) {
                    var othergrade = places[j].rating / 5 * 70 + places[j].reviews.length / 5 * 0.15 + places[j].photos.length / 10 * 0.15;
                    if (grade > top3places[j]) {
                      top3places.splice(j, 1);
                      top3places.push(places[i]);
                      break;
                    }
                  }
                }
              }
            console.log("Top 3 Places:")
            console.log(top3places)
            drivingdist = 0;
            var legs = dirresult.routes[0].legs;
              for (var k = 0; k < legs.length; ++k) {
                  drivingdist += legs[k].distance.value;
              }
            // convert from meters to miles
            drivingdist = drivingdist / 1609.344;
            // based score on a theoretical maximum enjoyment of a 5 star site (max photo, max review) site every 10 miles
            var score = totalgrade / (drivingdist / 10 * 100) * 100 ;
            console.log("Expected Enjoyment Score: " + score)
            }



            function tripCost(state_counts, mpg_data, dist) {
              var make = "Ferrari";
              var model = "308";
              var year = 1985;
              var mpg = mpg_data[make + model + year]
              var state_names = Object.keys(state_counts);
              var tot_boxes = 0;
              var avg_price = 0;


              for (state in state_counts) {
                tot_boxes += state_counts[state];
                avg_price += (state_counts[state] * gas_prices[state]);
              };

              avg_price = avg_price / tot_boxes;

              return d3.round(((dist / mpg) * avg_price),2)
              };



            function createMarker(place) {
              var image = {
                url: "https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle.png",
                size: new google.maps.Size(7, 7),
                anchor: new google.maps.Point(3.5, 3.5)
              };
              var marker = new google.maps.Marker({
                map: map,
                icon: image,
                position: place.geometry.location
              });

              markersArray.push(marker);

              var request = {
                reference: place.reference
              };

              google.maps.event.addListener(marker, 'click', function() {

                service.getDetails(request, function(place, status) {
                  if (status == 'OK') {
                    var info = '<h5>' + place.name + '</h5><p>' + place.formatted_address;
                    if (place.formatted_phone_number) {
                      info += '<br>' + place.formatted_phone_number;
                    }

                    info +=  '<br>' + place.rating + '/5 stars';


                    if (place.website) {
                      info += '<br><a target="_blank" href="' + place.website + '">' + place.website + '</a>';
                    }

                    infowindow.setContent(info);
                    infowindow.open(map, marker);
                  } else {
                    var info = "<h5>No Result, status=" + status + "</h5>";
                    infowindow.setContent(info);
                    infowindow.open(map, marker);
                  }
                });

               });
              marker.setMap(map);
            }

            google.maps.event.addDomListener(window, 'load', initialize);




        </script>
    </body>
</html>

